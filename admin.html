<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin | Lopes Barbearia</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #1e90ff; 
            --primary-hover: #1c86ee;
            --bg-dark: #0f0f0f; /* Ajustado para um pouco mais claro */
            --bg-card: #1a1a1a; /* Ajustado para melhor contraste */
            --text-main: #ffffff;
            --text-muted: #b0b0b0; /* Mais claro para melhor legibilidade */
            --border: #333333;
            --success: #10b981;
            --danger: #ef4444;
            --warn: #f59e0b;
            --accent: #3b82f6;
            --whatsapp: #25d366;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); line-height: 1.5; overflow-x: hidden; font-size: 14px; }

        /* Login - Mobile First */
        #login-screen { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            padding: 1rem;
        }
        
        .login-card { 
            background: var(--bg-card); 
            padding: 1.5rem; 
            border-radius: 1rem; 
            width: 100%; 
            max-width: 400px; 
            border: 1px solid var(--border);
        }

        /* Layout Mobile */
        #admin-panel { 
            display: none; 
            grid-template-columns: 1fr;
            min-height: 100vh;
        }
        
        /* Menu Hamburguer Mobile */
        .mobile-header {
            display: none;
            background: var(--bg-card);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .mobile-menu-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        aside { 
            background: var(--bg-card); 
            border-right: 1px solid var(--border); 
            padding: 1rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }
        
        aside.active {
            transform: translateX(0);
        }
        
        .nav-brand { 
            color: var(--primary); 
            font-weight: 900; 
            font-size: 1.1rem; 
            text-align: center; 
            margin-bottom: 0.5rem; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }
        
        .nav-menu { 
            display: flex; 
            flex-direction: column; 
            gap: 0.25rem; 
        }
        
        .nav-item { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.9rem;
        }
        
        .nav-item:hover, .nav-item.active { 
            background: #222222; 
            color: var(--primary); 
        }

        main { 
            padding: 1rem; 
            width: 100%; 
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Overlay para menu */
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .menu-overlay.active {
            display: block;
        }

        /* Stats - Mobile */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 0.75rem; 
            margin-bottom: 1.5rem; 
        }
        
        .stat-card { 
            background: var(--bg-card); 
            padding: 1rem; 
            border-radius: 0.75rem; 
            border: 1px solid var(--border); 
        }
        
        .stat-value { 
            font-size: 1.3rem; 
            font-weight: 700; 
            color: var(--text-main); 
            margin-top: 0.25rem; 
        }

        /* Agenda - Mobile */
        .calendar-wrapper { 
            display: flex; 
            flex-direction: column;
            gap: 1rem; 
            align-items: stretch; 
        }
        
        .calendar-card { 
            background: var(--bg-card); 
            border-radius: 0.75rem; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            width: 100%;
        }
        
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background: #111111; 
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background: var(--border); 
        }
        
        .calendar-day { 
            background: var(--bg-card); 
            min-height: 60px; 
            padding: 0.25rem; 
            cursor: pointer; 
            transition: 0.2s; 
            position: relative; 
            font-size: 0.8rem;
        }
        
        .calendar-day:hover { background: #222222; }
        .calendar-day.selected { border: 2px solid var(--primary); z-index: 10; }
        .calendar-day.closed { opacity: 0.4; background: #0a0a0a; }
        .day-number { font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; }
        
        .slots-container { 
            background: var(--bg-card); 
            border-radius: 0.75rem; 
            border: 1px solid var(--border); 
            padding: 1rem; 
            width: 100%;
        }
        
        .slots-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 8px; 
            margin-top: 1rem; 
        }
        
        .slot-btn { 
            padding: 10px; 
            border: 1px solid var(--border); 
            background: #111111; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: center; 
            font-size: 0.8rem; 
            transition: 0.2s;
            position: relative;
        }
        
        .slot-btn.occupied { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .slot-btn.blocked { background: #2a1010; color: var(--danger); border-color: var(--danger); opacity: 0.7; }
        .slot-btn.part-of-long { border-style: dashed; opacity: 0.9; }
        
        .slot-btn.active-editing {
            border: 2px solid var(--primary);
            box-shadow: 0 0 10px rgba(30, 144, 255, 0.4);
            transform: translateY(-2px);
        }

        /* Form Estilizado - Mobile */
        .admin-section { 
            background: var(--bg-card); 
            padding: 1rem; 
            border-radius: 0.75rem; 
            border: 1px solid var(--border); 
            margin-bottom: 1.5rem; 
        }
        
        .form-row { 
            display: flex; 
            flex-direction: column;
            gap: 0.75rem; 
            margin-bottom: 1rem; 
        }
        
        input, select, textarea { 
            background: #111111; 
            border: 1px solid var(--border); 
            padding: 0.75rem; 
            color: white; 
            border-radius: 0.5rem; 
            width: 100%; 
            outline: none; 
            font-size: 0.9rem;
        }
        
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        
        label { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin-bottom: 0.25rem; 
            display: block; 
        }
        
        .btn-action { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 0.75rem 1rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            font-size: 0.85rem;
            width: 100%;
        }
        
        .btn-action:hover { background: var(--primary-hover); opacity: 0.9; }

        .btn-whatsapp { 
            background: var(--whatsapp); 
            color: white; 
            border: none; 
            width: 36px; 
            height: 36px; 
            border-radius: 0.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .btn-whatsapp:hover { opacity: 0.8; }

        /* Tabelas - Mobile */
        .table-wrapper { 
            width: 100%; 
            overflow-x: auto; 
            background: var(--bg-card); 
            border-radius: 0.75rem; 
            border: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            text-align: left; 
            min-width: 600px;
        }
        
        th { 
            padding: 0.75rem; 
            background: #111111; 
            color: var(--text-muted); 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        td { 
            padding: 0.75rem; 
            border-bottom: 1px solid var(--border); 
            font-size: 0.8rem; 
        }
        
        tr:last-child td { border: none; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .charts-container { 
            display: flex; 
            flex-direction: column;
            gap: 1rem; 
            margin-top: 1.5rem; 
        }
        
        .chart-box {
            position: relative;
            height: 200px;
            width: 100%;
        }

        /* Toggle Autismo e Cortesia */
        .autismo-toggle { 
            display: flex; 
            gap: 6px; 
            margin-top: 5px; 
        }
        
        .toggle-btn { 
            flex: 1; 
            padding: 8px; 
            border: 1px solid var(--border); 
            background: #111111; 
            color: var(--text-muted); 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.8rem; 
            text-align: center; 
        }
        
        .toggle-btn.active-yes { background: var(--success); color: white; border-color: var(--success); }
        .toggle-btn.active-no { background: var(--danger); color: white; border-color: var(--danger); }
        .toggle-btn.active-primary { background: var(--primary); color: white; border-color: var(--primary); }

        /* Estilo Financeiro Toggle */
        .finance-toggle { 
            display: flex; 
            flex-wrap: wrap;
            margin-bottom: 1rem; 
            background: var(--border); 
            padding: 3px; 
            border-radius: 0.75rem; 
            width: 100%; 
            gap: 2px;
        }
        
        .finance-toggle button { 
            background: none; 
            border: none; 
            padding: 0.5rem; 
            color: var(--text-muted); 
            border-radius: 0.5rem; 
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.2s; 
            flex: 1;
            font-size: 0.75rem;
            min-width: 80px;
        }
        
        .finance-toggle button.active { 
            background: var(--bg-card); 
            color: var(--primary); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }

        /* Estilo Lançamento Rápido */
        .quick-launch-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
            gap: 8px; 
            margin-bottom: 15px; 
        }
        
        .btn-quick { 
            padding: 12px; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 3px; 
            font-size: 0.7rem;
        }
        
        .btn-quick:active { transform: scale(0.95); }

        /* Status Badge */
        .status-badge { 
            padding: 3px 6px; 
            border-radius: 10px; 
            font-size: 0.65rem; 
            font-weight: bold; 
            text-transform: uppercase; 
            display: inline-block;
        }
        
        .status-pago { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-pendente { background: rgba(245, 158, 11, 0.2); color: var(--warn); }
        
        /* Botões de ação em linha */
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn-action {
            width: auto;
            padding: 6px 10px;
            font-size: 0.75rem;
        }
        
        /* Melhorias para formulários em mobile */
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        /* Ajustes para telas maiores - CORREÇÃO IMPORTANTE */
        @media (min-width: 768px) {
            body { font-size: 16px; }
            
            #admin-panel { 
                grid-template-columns: 260px 1fr;
                display: grid !important; /* Força a exibição no desktop */
            }
            
            .mobile-header {
                display: none !important;
            }
            
            aside {
                position: sticky;
                top: 0;
                left: 0;
                transform: translateX(0) !important; /* Garante que fique visível */
                height: 100vh;
                z-index: 100;
            }
            
            main {
                padding: 1.5rem;
                margin-left: 0;
            }
            
            .menu-overlay {
                display: none !important;
            }
            
            .calendar-wrapper {
                display: grid;
                grid-template-columns: 1fr 350px;
            }
            
            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-container {
                display: grid;
                grid-template-columns: 1.5fr 1fr;
            }
            
            .btn-action {
                width: auto;
            }
            
            table {
                min-width: auto;
            }
            
            /* Remove qualquer comportamento mobile no desktop */
            .mobile-menu-btn {
                display: none;
            }
        }
        
        @media (min-width: 1024px) {
            main {
                padding: 2rem;
                max-width: 1400px;
                margin: 0 auto;
            }
            
            .calendar-wrapper {
                grid-template-columns: 1fr 400px;
            }
            
            .slots-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
        }
        
        /* Ajustes para iPhone SE e telas muito pequenas */
        @media (max-width: 374px) {
            .calendar-day {
                min-height: 50px;
                font-size: 0.7rem;
            }
            
            .day-number {
                font-size: 0.7rem;
            }
            
            .slot-btn {
                font-size: 0.75rem;
                padding: 8px;
            }
            
            .btn-action {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
        }
        
        /* Melhorias para orientação paisagem */
        @media (max-height: 500px) and (orientation: landscape) {
            aside {
                overflow-y: auto;
                padding-top: 3rem;
            }
            
            .calendar-day {
                min-height: 40px;
            }
        }
        
        /* Botão voltar ao topo */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
            z-index: 999;
            border: none;
        }
        
        .back-to-top:hover {
            opacity: 1;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Ajustes para inputs em mobile */
        input[type="date"],
        input[type="time"],
        select {
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Espaçamento seguro para iPhone X+ */
        @supports (padding: max(0px)) {
            body, .login-card, .admin-section, .stat-card {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
            }
            
            .mobile-header {
                padding-top: max(1rem, env(safe-area-inset-top));
            }
        }
        
        /* Estilo para toast/notificações */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            max-width: 90%;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .toast.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Estilo para modal em mobile */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }
        
        /* Classe para desktop - garante que o aside fique visível */
        .desktop-visible {
            transform: translateX(0) !important;
        }
        
        /* Ajuste específico para o problema do menu no desktop */
        @media (min-width: 768px) {
            #admin-panel {
                display: grid !important;
            }
            
            aside {
                display: flex !important;
                transform: translateX(0) !important;
            }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--primary); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem;">LOPES ADMIN</h2>
            <div style="margin-bottom: 1rem;"><label>Email</label><input type="email" id="login-email" autocomplete="email"></div>
            <div style="margin-bottom: 1.5rem;"><label>Senha</label><input type="password" id="login-password" autocomplete="current-password"></div>
            <button class="btn-action" id="btn-login" style="width: 100%;">ENTRAR</button>
            <p id="login-error" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px; text-align: center; display: none;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <!-- Header Mobile -->
        <div class="mobile-header">
            <button class="mobile-menu-btn" onclick="toggleMenu()">
                <i data-lucide="menu"></i>
            </button>
            <div class="nav-brand" style="font-size: 1rem;">Lopes Barbearia</div>
            <div style="width: 40px;"></div> <!-- Espaço para alinhamento -->
        </div>
        
        <!-- Overlay para menu -->
        <div class="menu-overlay" onclick="toggleMenu()"></div>
        
        <!-- Sidebar -->
        <aside class="desktop-visible">
            <div class="nav-brand">Lopes Barbearia</div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchTab('dashboard'); closeMenu();">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </div>
                <div class="nav-item" onclick="switchTab('agendamentos'); closeMenu();">
                    <i data-lucide="calendar"></i> Agenda
                </div>
                <div class="nav-item" onclick="switchTab('clientes'); closeMenu();">
                    <i data-lucide="users"></i> Clientes
                </div>
                <div class="nav-item" onclick="switchTab('assinaturas'); closeMenu();">
                    <i data-lucide="credit-card"></i> Assinaturas
                </div>
                <div class="nav-item" onclick="switchTab('finanças'); closeMenu();">
                    <i data-lucide="wallet"></i> Finanças
                </div>
                <div class="nav-item" onclick="switchTab('configurações'); closeMenu();">
                    <i data-lucide="settings"></i> Configurações
                </div>
            </nav>
            <button class="btn-action" onclick="logout()" style="margin-top: auto; background: var(--danger); color: white; border: none;">
                <i data-lucide="log-out"></i> SAIR
            </button>
        </aside>

        <main>
            <h2 id="view-title" style="margin-bottom: 1rem; font-size: 1.3rem;">Dashboard</h2>

            <div id="tab-dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.85rem;">Receita Bruta</span>
                        <div class="stat-value" id="dash-revenue" style="color: var(--primary)">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.85rem;">Despesas</span>
                        <div class="stat-value" id="dash-expense" style="color: var(--warn)">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <span style="color:var(--text-muted); font-size: 0.85rem;">Saldo</span>
                        <div class="stat-value" id="dash-profit" style="color: var(--success)">R$ 0,00</div>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:6px; margin-bottom:12px; overflow-x: auto; padding-bottom: 5px;">
                    <button id="period-month" class="btn-action" style="padding:6px 12px; font-size: 0.8rem;">Mês</button>
                    <button id="period-week" class="btn-action" style="padding:6px 12px; font-size: 0.8rem;">Semana</button>
                    <button id="period-year" class="btn-action" style="padding:6px 12px; font-size: 0.8rem;">Ano</button>
                </div>
                <div class="charts-container">
                    <div class="stat-card">
                        <div class="chart-box">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="chart-box">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-agendamentos" class="tab-content">
                <div class="calendar-wrapper">
                    <div class="calendar-card">
                        <div class="calendar-header">
                            <button class="btn-action" style="padding: 5px 8px; font-size: 0.8rem;" onclick="changeMonth(-1)">
                                <i data-lucide="chevron-left"></i>
                            </button>
                            <h3 id="calendar-month-year" style="font-size: 0.9rem;">...</h3>
                            <button class="btn-action" style="padding: 5px 8px; font-size: 0.8rem;" onclick="changeMonth(1)">
                                <i data-lucide="chevron-right"></i>
                            </button>
                        </div>
                        <div style="grid-template-columns: repeat(7, 1fr); text-align: center; background: #111111; padding: 8px 0; font-size: 0.65rem; color: var(--text-muted); font-weight: bold; display: grid;">
                            <div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SAB</div>
                        </div>
                        <div class="calendar-grid" id="calendar-body"></div>
                        
                        <div style="padding: 1rem; background: #111111; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-action" style="background: var(--danger); color: white; font-size: 0.8rem;" onclick="toggleDayStatus('closed')">FECHAR DIA</button>
                                <button class="btn-action" style="background: var(--success); color: white; font-size: 0.8rem;" onclick="toggleDayStatus('open')">ABRIR DIA</button>
                            </div>
                            <button class="btn-action" style="background: var(--primary); color: white; font-size: 0.8rem;" onclick="addExtraSlot()">+ HORÁRIO EXTRA</button>
                        </div>
                    </div>

                    <div class="slots-container">
                        <h4 id="selected-date-label" style="font-size: 1rem;">Data</h4>
                        <div class="slots-grid" id="slots-grid"></div>
                        
                        <div id="slot-editor" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h5 id="editor-title" style="color: var(--primary); font-size: 0.9rem;">Horário</h5>
                                <button id="btn-whatsapp-client" class="btn-whatsapp" title="Enviar Mensagem no WhatsApp" style="display: none;">
                                    <i data-lucide="message-circle"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label>Nome do Cliente</label>
                                    <input type="text" id="edit-client" placeholder="Nome do Cliente">
                                </div>
                                <div>
                                    <label>Telemóvel (Opcional)</label>
                                    <input type="tel" id="edit-phone" placeholder="28999999999">
                                </div>
                                <div>
                                    <label>Serviço</label>
                                    <select id="edit-service">
                                        <option value="Corte Masculino|25|1">Corte Masculino (R$ 25 - 30min)</option>
                                        <option value="Barba Completa|25|1">Barba (R$ 25 - 30min)</option>
                                        <option value="Combos|45|2">Combos (R$ 45-50 - 60min)</option>
                                        <option value="Corte Infantil|35|1">Corte Infantil (R$ 35 - 30min)</option>
                                        <option value="Sobrancelha|15|1">Sobrancelha (R$ 15 - 15min)</option>
                                        <option value="Pigmentação|25|1">Pigmentação (R$ 25 - 20min)</option>
                                        <option value="Depilação Nariz/Orelha|10|1">Depilação Nariz/Orelha (R$ 10 - 10min)</option>
                                        <option value="Cortesia|0|1">Cortesia (R$ 0)</option>
                                    </select>
                                </div>
                                <div id="autismo-container" style="display: none;">
                                    <label>Autismo?</label>
                                    <div class="autismo-toggle">
                                        <button id="autismo-yes" class="toggle-btn" onclick="setAutismo(true)">✅</button>
                                        <button id="autismo-no" class="toggle-btn" onclick="setAutismo(false)">⛔</button>
                                    </div>
                                </div>
                                <div id="cortesia-slots-container" style="display: none;">
                                    <label>Quantos horários para a Cortesia?</label>
                                    <div class="autismo-toggle">
                                        <button id="cortesia-1" class="toggle-btn" onclick="setCortesiaSlots(1)">1 Horário</button>
                                        <button id="cortesia-2" class="toggle-btn" onclick="setCortesiaSlots(2)">2 Horários</button>
                                    </div>
                                </div>
                                <div>
                                    <label>Observações (Atendimento especializado)</label>
                                    <textarea id="edit-observations" placeholder="Preferências sensoriais, notas" style="width:100%; height:70px; margin-top:8px; padding:8px; background:#111111; color:#fff; border:1px solid var(--border); border-radius:6px; font-size: 0.9rem;"></textarea>
                                </div>
                                <div id="warning-double" style="display:none; color: var(--danger); font-size: 0.7rem; font-weight: bold;">
                                    ⚠️ Este serviço requer 2 horários seguidos.
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <button class="btn-action" onclick="saveBooking()">SALVAR</button>
                                    <button class="btn-action" style="background: #333; color: white;" onclick="toggleBlockSlot()">BLOQUEAR</button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <button id="btn-complete-booking" style="background: var(--success); color: white; border: none; padding: 0.7rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: none;" onclick="completeBooking()">CONCLUIR</button>
                                    <button id="btn-cancel-booking" style="background: var(--danger); color: white; border: none; padding: 0.7rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: none;" onclick="cancelBooking()">CANCELAR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-clientes" class="tab-content">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Contato</th>
                                <th>Última Visita</th>
                                <th>Total</th>
                                <th onclick="toggleClientSort()">Dias ⬍</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="list-clients"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-finanças" class="tab-content">
                <div class="finance-toggle">
                    <button id="toggle-despesas" class="active" onclick="switchFinanceMode('despesas')">DESPESAS</button>
                    <button id="toggle-entradas" onclick="switchFinanceMode('entradas')">ENTRADAS</button>
                    <button id="toggle-relatorios" onclick="switchFinanceMode('relatorios')">RELATÓRIOS</button>
                </div>

                <div class="admin-section" id="section-finance-form">
                    <h4 id="finance-form-title" style="margin-bottom: 1rem; font-size: 1rem;">Lançar Nova Despesa</h4>
                    
                    <div id="quick-products-container" style="display: none;">
                        <div class="quick-launch-grid">
                            <button class="btn-quick" style="background: #e67e22;" onclick="quickAdd('Cremes / Pomadas')">
                                <i data-lucide="package"></i>CREME
                            </button>
                            <button class="btn-quick" style="background: #27ae60;" onclick="quickAdd('Chips / Snacks')">
                                <i data-lucide="cookie"></i>CHIPS
                            </button>
                            <button class="btn-quick" style="background: #2980b9;" onclick="quickAdd('Refrigerantes')">
                                <i data-lucide="cup-soda"></i>REFRI
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div><label>Descrição</label><input type="text" id="exp-desc" placeholder="Ex: Energia"></div>
                        <div><label>Valor (R$)</label><input type="number" id="exp-val" step="0.01"></div>
                        <div><label>Data</label><input type="date" id="exp-date"></div>
                        <div id="recurrence-container">
                            <label>Recorrência</label>
                            <select id="exp-recurrence">
                                <option value="">Nenhuma</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensal</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                        <div id="col-cat">
                            <label>Categoria</label>
                            <select id="exp-category"></select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="btn-finance-add" class="btn-action" style="background: var(--danger); color: white;" onclick="addFinanceRecord(false)">ADICIONAR</button>
                            <button id="btn-finance-add-paid" class="btn-action" style="background: var(--success); color: white;" onclick="addFinanceRecord(true)">PAGO ✅</button>
                        </div>
                    </div>
                </div>

                <div class="admin-section" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div>
                            <label>Filtrar por Categoria</label>
                            <select id="filter-category" onchange="renderFinanceTable()">
                                <option value="all">Todas as Categorias</option>
                            </select>
                        </div>
                        <div>
                            <label>Buscar por Descrição</label>
                            <input type="text" id="filter-search" placeholder="Buscar..." oninput="renderFinanceTable()">
                        </div>
                    </div>
                    <div style="background: #111111; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px;">
                        <span id="label-total-filtrado" style="font-size: 0.7rem; color: var(--text-muted); display: block;">Total Despesas</span>
                        <strong id="filtered-total" style="color: var(--warn); font-size: 1rem;">R$ 0,00</strong>
                    </div>
                </div>
                
                <div class="table-wrapper" id="section-finance-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th class="col-recurrence">Recorrência</th>
                                <th>Categoria</th>
                                <th>Descrição</th>
                                <th class="col-status">Status</th>
                                <th>Valor</th>
                                <th style="text-align: right;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="list-finance"></tbody>
                    </table>
                </div>

                <div id="section-relatorios" style="display: none;">
                    <div class="admin-section">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem;">Relatório Fiscal - Serviços Concluídos e Vendas</h4>
                        <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.85rem;">
                            Como seu sistema ajuda na emissão de notas fiscais:<br>
                            <strong>Fonte de Dados Confiável:</strong> Na Agenda, toda vez que você marca um atendimento como "Concluído", ele já registra data, cliente, serviço e valor. 
                            Na aba Finanças > Entradas, as vendas de produtos também ficam registradas.<br>
                            <strong>Relatório para o Contador:</strong> Periodicamente (ex.: todo mês), você pode extrair uma lista dos serviços concluídos e vendas feitas. 
                            Passe essa lista para seu contador, que usará os dados para emitir as notas fiscais em lote no sistema oficial.
                        </p>
                        
                        <div class="form-row">
                            <div>
                                <label>Ano</label>
                                <select id="report-year">
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div>
                                <label>Mês</label>
                                <select id="report-month">
                                    <option value="">Todos os meses</option>
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Março</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div>
                                <label>Semana</label>
                                <select id="report-week">
                                    <option value="">Todo o período</option>
                                    <option value="1">Semana 1 (dias 1-7)</option>
                                    <option value="2">Semana 2 (dias 8-14)</option>
                                    <option value="3">Semana 3 (dias 15-21)</option>
                                    <option value="4">Semana 4 (dias 22-28)</option>
                                    <option value="5">Semana 5 (dias 29-31)</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn-action" onclick="generateFiscalReport()" style="margin-top: 1.5rem;">GERAR RELATÓRIO</button>
                            </div>
                        </div>

                        <div id="report-results" style="display: none; margin-top: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
                                <h5 style="font-size: 0.9rem;">Resultado do Período</h5>
                                <button class="btn-action" onclick="exportFiscalReport()" style="background: var(--success); padding: 6px 12px; font-size: 0.75rem;">EXPORTAR CSV</button>
                            </div>
                            
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Cliente</th>
                                            <th>Descrição</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="report-table-body"></tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border);">
                                <div>
                                    <strong id="report-total" style="color: var(--primary); font-size: 1rem;">Total do período: R$ 0,00</strong><br>
                                    <span id="report-summary" style="color: var(--text-muted); font-size: 0.75rem;">0 serviços + 0 produtos</span>
                                </div>
                                <div id="report-period-info" style="color: var(--text-muted); font-size: 0.75rem; margin-top: 5px;">
                                    Período: -
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-assinaturas" class="tab-content">
                <div class="admin-section">
                    <h4 style="margin-bottom: 1rem; font-size: 1rem;">Gerenciar Assinaturas</h4>
                    
                    <div class="form-row">
                        <div><label>Cliente</label><input type="text" id="sub-client" placeholder="Nome do cliente"></div>
                        <div><label>Telefone</label><input type="tel" id="sub-phone" placeholder="28999999999"></div>
                        <div><label>Plano</label>
                            <select id="sub-service" onchange="updatePlanDetails()">
                                <option value="">Selecione um plano...</option>
                                <option value="sempre-alinhado">Sempre Alinhado - R$ 79,90/mês</option>
                                <option value="combo-executivo">Combo Executivo - R$ 119,90/mês</option>
                                <option value="vip-premium">VIP Premium - R$ 159,90/mês</option>
                            </select>
                        </div>
                        <div><label>Valor (R$)</label><input type="number" id="sub-value" step="0.01" readonly></div>
                        <div><label>Data Início</label><input type="date" id="sub-start-date"></div>
                        <div><label>Status</label>
                            <select id="sub-status">
                                <option value="active">Ativa</option>
                                <option value="inactive">Inativa</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn-action" onclick="addSubscription()">ADICIONAR ASSINATURA</button>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Telefone</th>
                                <th>Plano</th>
                                <th>Valor</th>
                                <th>Início</th>
                                <th>Próx. Cobrança</th>
                                <th>Status</th>
                                <th style="text-align: right;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="list-subscriptions"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-configurações" class="tab-content">
                <div class="admin-section">
                    <h4 style="margin-bottom: 1rem; font-size: 1rem;">Configurar Serviços</h4>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.85rem;">Edite os preços e durações dos serviços. As mudanças serão aplicadas automaticamente no site.</p>
                    
                    <div id="services-list" class="table-wrapper">  
                        <table>
                            <thead>
                                <tr>
                                    <th>Serviço</th>
                                    <th>Duração (min)</th>
                                    <th>Preço (R$)</th>
                                    <th style="text-align: right;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="list-services"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Botão Voltar ao Topo -->
        <button class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
            <i data-lucide="chevron-up"></i>
        </button>
        
        <!-- Toast Notifications -->
        <div class="toast" id="toast"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLBFTLC7sqM9VUhlsypPugQ-LhcX7-0Rw",
            authDomain: "barbearia-do-rei.firebaseapp.com",
            projectId: "barbearia-do-rei",
            storageBucket: "barbearia-do-rei.firebasestorage.app",
            messagingSenderId: "546744214164",
            appId: "1:546744214164:web:5bd367381afbef253d0a81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Mapeamento de cores por serviço
        const serviceColors = {
            "Corte Masculino": "#0800ff",
            "Barba Completa": "#d0ff00",
            "Combos": "#3cff00",
            "Combo Corte + Barba": "#3cff00",
            "Combo Completo: Cabelo, Barba e Sombrancelha": "#ff6b00",
            "Corte Infantil": "#10b981",
            "Corte Infantil (Autismo)": "#10b981",
            "Cortesia": "#a0a0a0",
            "Bloqueio": "#ef4444",
            "Outros": "#3b82f6"
        };

        let agendamentosData = [];
        let configDiasData = {};
        let despesasData = [];
        let entradasData = [];
        let financeMode = 'despesas';

        const financeCategories = {
            despesas: ["Produtos", "Aluguel", "Marketing", "Manutenção", "Utilidades", "Pessoal", "Outros"],
            entradas: ["Refrigerantes", "Chips / Snacks", "Cremes / Pomadas", "Outros Produtos"]
        };

        let currentCalendarDate = new Date();
        let selectedDateISO = new Date().toISOString().split('T')[0];
        let selectedSlot = null;
        let isAutismo = false;
        let cortesiaSlots = 1;
        let mainChart = null;
        let pieChart = null;
        let sortClientsByInactivity = true;
        let financeSort = { column: 'data', direction: 'desc' };
        let subscriptionsData = [];
        let servicesData = [];

        const baseSlots = ["09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30"];

        // Função para mostrar toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            
            // Definir cor baseada no tipo
            if (type === 'success') {
                toast.style.background = 'var(--success)';
            } else if (type === 'error') {
                toast.style.background = 'var(--danger)';
            } else if (type === 'warning') {
                toast.style.background = 'var(--warn)';
            } else {
                toast.style.background = 'var(--primary)';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Função para alternar menu mobile
        window.toggleMenu = () => {
            // No desktop, não faz nada
            if (window.innerWidth >= 768) return;
            
            const aside = document.querySelector('aside');
            const overlay = document.querySelector('.menu-overlay');
            
            aside.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Prevenir scroll do body quando menu está aberto
            if (aside.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        };

        // Fechar menu ao clicar em um item
        function closeMenu() {
            // No desktop, não fecha
            if (window.innerWidth >= 768) return;
            
            const aside = document.querySelector('aside');
            const overlay = document.querySelector('.menu-overlay');
            
            aside.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Função Global para o Toggle Autismo
        window.setAutismo = (val) => {
            isAutismo = val;
            const btnYes = document.getElementById('autismo-yes');
            const btnNo = document.getElementById('autismo-no');
            
            if(btnYes && btnNo) {
                if(val) {
                    btnYes.classList.add('active-yes');
                    btnNo.classList.remove('active-no');
                } else {
                    btnNo.classList.add('active-no');
                    btnYes.classList.remove('active-yes');
                }
            }
            updateWarning();
        };

        // Função Global para os Slots da Cortesia
        window.setCortesiaSlots = (num) => {
            cortesiaSlots = num;
            const btn1 = document.getElementById('cortesia-1');
            const btn2 = document.getElementById('cortesia-2');
            
            if(btn1 && btn2) {
                if(num === 1) {
                    btn1.classList.add('active-primary');
                    btn2.classList.remove('active-primary');
                } else {
                    btn2.classList.add('active-primary');
                    btn1.classList.remove('active-primary');
                }
            }
            updateWarning();
        };

        window.notifyInactive = (nome, telefone, dias) => {
            const clean = telefone.replace(/\D/g, "");
            const phone = clean.startsWith("55") ? clean : "55" + clean;
            const msg = encodeURIComponent(
                `Olá, ${nome}! 👋\n\n` +
                `Sentimos sua falta na *Lopes Barbearia*! ✂️\n` +
                `Já fazem ${dias} dias desde sua última visita.\n\n` +
                `Que tal agendar um horário pra dar aquele tapa no visual? 😉`
            );
            window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${msg}`);
        };

        window.toggleClientSort = () => {
            sortClientsByInactivity = !sortClientsByInactivity;
            renderClients();
        };

        window.toggleFinanceSort = (column) => {
            if (financeSort.column === column) {
                financeSort.direction = financeSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                financeSort.column = column;
                financeSort.direction = 'desc';
            }
            renderFinanceTable();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Atualizar título
            const titles = {
                'dashboard': 'Dashboard',
                'agendamentos': 'Agenda',
                'clientes': 'Clientes',
                'assinaturas': 'Assinaturas',
                'finanças': 'Finanças',
                'configurações': 'Configurações'
            };
            document.getElementById('view-title').innerText = titles[tab] || tab;
            
            // Ativar item do menu
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.includes(titles[tab])) {
                    item.classList.add('active');
                }
            });
            
            // Fechar menu no mobile
            closeMenu();
            
            // Executar funções específicas da tab
            if(tab === 'dashboard') {
                setTimeout(() => updateDashboard(), 50);
            }
            if(tab === 'agendamentos') renderCalendar();
            if(tab === 'clientes') renderClients();
            if(tab === 'assinaturas') renderSubscriptions();
            if(tab === 'finanças') switchFinanceMode('despesas');
            if(tab === 'configurações') renderServices();
            
            // Scroll para o topo no mobile
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'grid';
                initListeners();
                showToast('Login realizado com sucesso!', 'success');
                
                // Garantir que o menu fique visível no desktop após login
                setTimeout(() => {
                    if (window.innerWidth >= 768) {
                        const aside = document.querySelector('aside');
                        if (aside) {
                            aside.style.transform = 'translateX(0)';
                            aside.style.display = 'flex';
                        }
                    }
                }, 100);
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
            }
        });

        const loginError = document.getElementById('login-error');
        const btnLogin = document.getElementById('btn-login');
        if(btnLogin) {
            btnLogin.onclick = async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    loginError.innerText = "Por favor, preencha todos os campos.";
                    loginError.style.display = 'block';
                    return;
                }

                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i data-lucide="loader-2" class="spin"></i> AUTENTICANDO...';
                loginError.style.display = 'none';

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = 'ENTRAR';
                    loginError.style.display = 'block';
                    if (error.code === 'auth/invalid-credential') {
                        loginError.innerText = "Credenciais inválidas.";
                    } else {
                        loginError.innerText = "Erro: " + error.message;
                    }
                }
            };
        }

        window.logout = () => {
            if (confirm('Deseja realmente sair?')) {
                signOut(auth);
                showToast('Logout realizado com sucesso', 'info');
            }
        };

        function initListeners() {
            onSnapshot(collection(db, "agendamentos"), snap => {
                agendamentosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                try {
                    const serviceSelect = document.getElementById('edit-service');
                    const options = serviceSelect ? Array.from(serviceSelect.options).map(o => {
                        const parts = o.value.split('|');
                        return { name: (parts[0] || '').trim(), price: parseFloat(parts[1]) || 0 };
                    }) : [];

                    agendamentosData = agendamentosData.map(a => {
                        const out = { ...a };
                        out.preco = Number(out.preco) || 0;

                        if (options.length) {
                            const originalServ = (out.servico || '').toString();
                            const target = originalServ.toLowerCase();

                            let match = options.find(o => o.name.toLowerCase() === target || o.name.toLowerCase().includes(target) || target.includes(o.name.toLowerCase()));

                            if (!match && out.preco !== undefined) {
                                match = options.find(o => Math.abs((o.price || 0) - Number(out.preco || 0)) < 0.01);
                            }

                            if (match) {
                                if (out.preco === undefined || out.preco === 0) out.preco = match.price;
                                const hasAutismo = out.autismo === true || /autis/i.test(originalServ);
                                out.servico = match.name + (hasAutismo ? ' (Autismo)' : '');
                            }
                        }

                        return out;
                    });
                } catch (e) {
                    console.warn('Normalization failed:', e);
                }

                updateDashboard();
                renderClients();
                renderCalendar();
                renderSlots();
            });

            onSnapshot(collection(db, "config_dias"), snap => {
                configDiasData = {};
                snap.forEach(d => configDiasData[d.id] = d.data());
                renderCalendar();
                renderSlots();
            });

            onSnapshot(collection(db, "services"), snap => {
                servicesData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (servicesData.length === 0) {
                    const defaultServices = [
                        { name: "Corte Masculino", duration: 30, price: 25 },
                        { name: "Barba Completa", duration: 30, price: 25 },
                        { name: "Combos", duration: 60, price: 45 },
                        { name: "Corte Infantil", duration: 30, price: 35 },
                        { name: "Sobrancelha", duration: 15, price: 15 },
                        { name: "Pigmentação", duration: 20, price: 25 },
                        { name: "Depilação Nariz/Orelha", duration: 10, price: 10 }
                    ];
                    defaultServices.forEach(async (service) => {
                        await addDoc(collection(db, "services"), service);
                    });
                }
                renderServices();
            });

            onSnapshot(collection(db, "despesas"), snap => {
                despesasData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(financeMode === 'despesas') renderFinanceTable();
                updateDashboard();
            });

            onSnapshot(collection(db, "entradas_produtos"), snap => {
                entradasData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(financeMode === 'entradas') renderFinanceTable();
                updateDashboard();
            });

            onSnapshot(collection(db, "assinaturas"), snap => {
                subscriptionsData = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderSubscriptions();
            });
        }

        window.changeMonth = (v) => { 
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + v); 
            renderCalendar(); 
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-body');
            const label = document.getElementById('calendar-month-year');
            if(!grid || !label) return;
            
            grid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            label.innerText = new Intl.DateTimeFormat('pt-BR', {month:'long', year:'numeric'}).format(currentCalendarDate).toUpperCase();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="calendar-day" style="opacity:0"></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const [y, m, dayNum] = iso.split('-').map(Number);
                const dayOfWeek = new Date(y, m - 1, dayNum).getDay();
                const config = configDiasData[iso] || { status: (dayOfWeek === 0 ? 'closed' : 'open') };
                const dayAgends = agendamentosData.filter(a => a.data === iso);

                const div = document.createElement('div');
                div.className = `calendar-day ${iso === selectedDateISO ? 'selected' : ''} ${config.status === 'closed' ? 'closed' : ''}`;
                div.onclick = async () => {
                    selectedDateISO = iso;
                    renderCalendar();
                    renderSlots();
                    // Scroll para os slots no mobile
                    if (window.innerWidth < 768) {
                        document.querySelector('.slots-container').scrollIntoView({behavior: 'smooth'});
                    }
                };
                div.innerHTML = `<div class="day-number">${d}</div>`;
                
                dayAgends.forEach(a => {
                    const baseService = (a.servico || "").replace(" (Autismo)", "");
                    const color = a.status === 'blocked' ? serviceColors["Bloqueio"] : (serviceColors[baseService] || serviceColors["Outros"]);
                    div.innerHTML += `<span style="width:4px;height:4px;background:${color};display:inline-block;margin:1px;border-radius:1px"></span>`;
                });
                grid.appendChild(div);
            }
            
            // Atualizar ícones
            lucide.createIcons();
        }

        function renderSlots() {
            const grid = document.getElementById('slots-grid');
            if(!grid) return;
            document.getElementById('selected-date-label').innerText = selectedDateISO.split('-').reverse().join('/');
            document.getElementById('slot-editor').style.display = 'none';
            grid.innerHTML = '';

            const config = configDiasData[selectedDateISO] || {};
            const slots = config.extraSlots ? [...baseSlots, ...config.extraSlots].sort() : baseSlots;

            slots.forEach((time, index) => {
                const agend = agendamentosData.find(a => a.data === selectedDateISO && a.hora === time);
                const btn = document.createElement('div');
                
                let isPartOfLong = false;
                if (index > 0) {
                    const prevTime = slots[index - 1];
                    const prevAgend = agendamentosData.find(a => a.data === selectedDateISO && a.hora === prevTime);
                    if (prevAgend && prevAgend.slots === 2) isPartOfLong = true;
                }

                const isEditing = selectedSlot && selectedSlot.time === time;
                btn.className = `slot-btn ${agend ? (agend.status === 'blocked' ? 'blocked' : 'occupied') : ''} ${isPartOfLong ? 'part-of-long' : ''} ${isEditing ? 'active-editing' : ''}`;
                
                if (agend) {
                    let displayName = agend.nome || agend.cliente || '...';
                    if(agend.status === 'completed') {
                        displayName += ' ✅';
                    }
                    // Limitar tamanho do nome no mobile
                    if (window.innerWidth < 768 && displayName.length > 15) {
                        displayName = displayName.substring(0, 12) + '...';
                    }
                    btn.innerText = `${time} - ${agend.status === 'blocked' ? 'BLOQUEADO' : displayName}`;
                    const baseService = (agend.servico || "").replace(" (Autismo)", "");
                    const sColor = agend.status === 'blocked' ? serviceColors["Bloqueio"] : (serviceColors[baseService] || serviceColors["Outros"]);
                    btn.style.borderLeft = `3px solid ${sColor}`;
                } else if (isPartOfLong) {
                    const owner = agendamentosData.find(a => a.data === selectedDateISO && a.hora === slots[index-1]);
                    const ownerName = owner ? (owner.nome || owner.cliente || '...') : '...';
                    // Limitar tamanho no mobile
                    const displayOwnerName = window.innerWidth < 768 && ownerName.length > 10 ? 
                        ownerName.substring(0, 8) + '...' : ownerName;
                    btn.innerText = `${time} - (${displayOwnerName})`;
                    btn.style.opacity = "0.5";
                } else {
                    btn.innerText = time;
                }

                btn.onclick = () => {
                    if (isPartOfLong) return;
                    openSlotEditor(time, agend, slots, index);
                };
                grid.appendChild(btn);
            });
            lucide.createIcons();
        }

        function openSlotEditor(time, agend, allSlots, index) {
            selectedSlot = { time, agend, allSlots, index };
            renderSlots();
            
            document.getElementById('slot-editor').style.display = 'block';
            document.getElementById('editor-title').innerText = `Horário: ${time}`;
            const editClientVal = agend ? ((agend.nome === 'BLOQUEADO' || agend.cliente === 'BLOQUEADO') ? '' : (agend.nome || agend.cliente || '')) : '';
            document.getElementById('edit-client').value = editClientVal;
            document.getElementById('edit-phone').value = agend?.telefone || '';
            
            const serviceSelect = document.getElementById('edit-service');
            if (agend && agend.servico) {
                const target = agend.servico.toString().toLowerCase();
                for (let i = 0; i < serviceSelect.options.length; i++) {
                    const optName = serviceSelect.options[i].value.split('|')[0].toLowerCase();
                    if (optName === target || optName.includes(target) || target.includes(optName)) {
                        serviceSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            setAutismo(agend?.autismo || false);
            setCortesiaSlots(agend?.slots || 1);

            document.getElementById('edit-observations').value = agend?.observacoes || '';
            document.getElementById('btn-cancel-booking').style.display = agend ? 'block' : 'none';
            document.getElementById('btn-complete-booking').style.display = (agend && agend.status !== 'completed' && agend.status !== 'blocked') ? 'block' : 'none';
            
            const btnWhatsapp = document.getElementById('btn-whatsapp-client');
            if (agend && agend.status !== 'blocked') {
                btnWhatsapp.style.display = 'flex';
                btnWhatsapp.onclick = () => {
                    const telefone = agend.telefone || prompt("Insira o número de WhatsApp do cliente (com DDD):", "2899082741");
                    if(!telefone) return;
                    const cleanPhone = telefone.replace(/\D/g, "");
                    const fullPhone = cleanPhone.startsWith("55") ? cleanPhone : "55" + cleanPhone;
                    const displayName = agend.nome || agend.cliente || 'cliente';
                    const msg = encodeURIComponent(`Olá, ${displayName}! 👋\n\nEstou passando para confirmar o seu agendamento na *Lopes Barbearia*.\n\n📅 Data: ${agend.data.split('-').reverse().join('/')}\n⏰ Hora: ${agend.hora}h\n✂️ Serviço: ${agend.servico}\n\nPodemos confirmar? 😉`);
                    window.open(`https://api.whatsapp.com/send?phone=${fullPhone}&text=${msg}`);
                };
            } else {
                btnWhatsapp.style.display = 'none';
            }
            updateWarning();
            
            // Scroll para o editor no mobile
            if (window.innerWidth < 768) {
                document.getElementById('slot-editor').scrollIntoView({behavior: 'smooth'});
            }
        }

        function updateWarning() {
            const serviceSelect = document.getElementById('edit-service');
            if(!serviceSelect) return;

            const servRaw = serviceSelect.value.split('|');
            const isInfantil = servRaw[0].includes("Infantil");
            const isCortesia = servRaw[0].includes("Cortesia");
            
            const autismoContainer = document.getElementById('autismo-container');
            const cortesiaContainer = document.getElementById('cortesia-slots-container');
            
            autismoContainer.style.display = isInfantil ? 'block' : 'none';
            cortesiaContainer.style.display = isCortesia ? 'block' : 'none';

            if (!isInfantil && isAutismo) setAutismo(false);

            let slotsNeeded = parseInt(servRaw[2]);
            if (isAutismo) slotsNeeded = 2;
            if (isCortesia) slotsNeeded = cortesiaSlots;

            const warning = document.getElementById('warning-double');
            if(warning) warning.style.display = (slotsNeeded > 1) ? 'block' : 'none';
        }
        
        document.getElementById('edit-service').onchange = updateWarning;

        window.saveBooking = async () => {
            const nome = document.getElementById('edit-client').value;
            const telefone = document.getElementById('edit-phone').value;
            const observacoes = document.getElementById('edit-observations').value || '';
            const servRaw = document.getElementById('edit-service').value.split('|');
            
            let slotsNeeded = parseInt(servRaw[2]);
            let precoFinal = parseFloat(servRaw[1]);
            let servicoFinal = servRaw[0];

            if(isAutismo) {
                slotsNeeded = 2;
                servicoFinal += " (Autismo)";
                if(servRaw[0].includes("Infantil")) precoFinal = 60;
            }

            if(servRaw[0].includes("Cortesia")) {
                slotsNeeded = cortesiaSlots;
            }

            if(!nome) {
                showToast('Insira o nome do cliente', 'warning');
                return;
            }

            if (slotsNeeded > 1) {
                const nextTime = selectedSlot.allSlots[selectedSlot.index + 1];
                if (!nextTime) {
                    showToast("Não há horário seguinte disponível.", 'warning');
                    return;
                }
                const nextBusy = agendamentosData.find(a => a.data === selectedDateISO && a.hora === nextTime);
                if (nextBusy && (!selectedSlot.agend || nextBusy.id !== selectedSlot.agend.id)) {
                    showToast("O próximo horário está ocupado.", 'warning');
                    return;
                }
            }

            const data = {
                nome, telefone, observacoes, data: selectedDateISO, hora: selectedSlot.time,
                servico: servicoFinal, preco: precoFinal,
                autismo: isAutismo,
                slots: slotsNeeded,
                status: selectedSlot.agend?.status || 'confirmed', timestamp: new Date()
            };

            try {
                if(selectedSlot.agend) {
                    await updateDoc(doc(db, "agendamentos", selectedSlot.agend.id), data);
                    showToast('Agendamento atualizado com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, "agendamentos"), data);
                    showToast('Agendamento criado com sucesso!', 'success');
                }
                document.getElementById('slot-editor').style.display = 'none';
                selectedSlot = null;
                renderSlots();
            } catch(e) { 
                showToast('Erro ao salvar: ' + e.message, 'error');
            }
        };

        window.completeBooking = async () => {
            if(!selectedSlot || !selectedSlot.agend) return;
            
            if(confirm('Confirmar que o cliente compareceu e finalizar atendimento? (O valor entrará na receita bruta)')){
                try {
                    await updateDoc(doc(db, "agendamentos", selectedSlot.agend.id), { status: 'completed' });
                    showToast('Atendimento concluído com sucesso!', 'success');
                    document.getElementById('slot-editor').style.display = 'none';
                    selectedSlot = null;
                    renderSlots();
                } catch(e) { 
                    showToast('Erro ao finalizar: ' + e.message, 'error');
                }
            }
        };

        window.cancelBooking = async () => {
            if(!selectedSlot || !selectedSlot.agend) return;
            const ag = selectedSlot.agend;

            if(confirm('Cancelar agendamento?')) {
                try {
                    await deleteDoc(doc(db, "agendamentos", ag.id));
                    showToast('Agendamento cancelado!', 'info');
                    document.getElementById('slot-editor').style.display = 'none';
                    selectedSlot = null;
                    renderSlots();
                } catch(e) {
                    showToast('Erro ao cancelar: ' + e.message, 'error');
                }
            }
        };

        window.toggleBlockSlot = async () => {
            const data = {
                nome: "BLOQUEADO", data: selectedDateISO, hora: selectedSlot.time,
                servico: "Bloqueio", preco: 0, status: 'blocked', slots: 1, timestamp: new Date()
            };
            try {
                if(selectedSlot.agend) {
                    await updateDoc(doc(db, "agendamentos", selectedSlot.agend.id), data);
                } else {
                    await addDoc(collection(db, "agendamentos"), data);
                }
                showToast('Horário bloqueado com sucesso!', 'info');
                document.getElementById('slot-editor').style.display = 'none';
                selectedSlot = null;
                renderSlots();
            } catch(e) {
                showToast('Erro ao bloquear horário: ' + e.message, 'error');
            }
        };

        window.toggleDayStatus = async (status) => {
            try {
                await setDoc(doc(db, "config_dias", selectedDateISO), { status, updatedAt: new Date() }, { merge: true });
                renderSlots();
                showToast(`Dia ${selectedDateISO} atualizado para: ${status === 'closed' ? 'FECHADO' : 'ABERTO'}`, 'success');
            } catch (e) { 
                showToast('Erro ao atualizar status do dia: ' + e.message, 'error');
            }
        };

        window.addExtraSlot = async () => {
            const configRef = doc(db, "config_dias", selectedDateISO);
            const snap = await getDoc(configRef);
            const config = snap.exists() ? snap.data() : {};
            const currentSlots = config.extraSlots ? [...baseSlots, ...config.extraSlots].sort() : [...baseSlots].sort();
            
            const lastTime = currentSlots[currentSlots.length - 1];
            const [h, m] = lastTime.split(':').map(Number);
            let nextM = m + 40;
            let nextH = h;
            if(nextM >= 60) { nextH++; nextM -= 60; }
            const newTime = `${String(nextH).padStart(2,'0')}:${String(nextM).padStart(2,'0')}`;
            
            const extras = config.extraSlots || [];
            extras.push(newTime);
            await setDoc(configRef, { extraSlots: extras }, { merge: true });
            showToast('Horário extra adicionado com sucesso!', 'success');
            renderSlots();
        };

        let currentPeriod = 'month';
        function setDashboardPeriod(p) {
            currentPeriod = p;
            document.getElementById('period-month').style.opacity = p === 'month' ? 1 : 0.6;
            document.getElementById('period-week').style.opacity = p === 'week' ? 1 : 0.6;
            document.getElementById('period-year').style.opacity = p === 'year' ? 1 : 0.6;
            updateDashboard();
        }
        document.getElementById('period-month').onclick = () => setDashboardPeriod('month');
        document.getElementById('period-week').onclick = () => setDashboardPeriod('week');
        document.getElementById('period-year').onclick = () => setDashboardPeriod('year');

        function getPeriodRange(p) {
            const now = new Date();
            if (p === 'month') {
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth()+1, 1);
                return {start, end};
            } else if (p === 'week') {
                const start = new Date(now);
                const day = (start.getDay() + 6) % 7; 
                start.setHours(0,0,0,0);
                start.setDate(start.getDate() - day);
                const end = new Date(start);
                end.setDate(start.getDate() + 7);
                return {start, end};
            } else {
                const start = new Date(now.getFullYear(), 0, 1);
                const end = new Date(now.getFullYear()+1, 0, 1);
                return {start, end};
            }
        }

        function updateDashboard() {
            const range = getPeriodRange(currentPeriod);
            let rev = 0; 
            const sMap = {};

            agendamentosData.forEach(a => { 
                if(a.status === 'completed' && (a.nome || a.cliente) !== 'BLOQUEADO') {
                    const dt = new Date(a.data + 'T00:00:00');
                    if (dt >= range.start && dt < range.end) {
                        rev += Number(a.preco || 0);
                        sMap[a.servico] = (sMap[a.servico] || 0) + 1;
                    }
                }
            });

            entradasData.forEach(e => {
                const dt = new Date(e.data + 'T00:00:00');
                if (dt >= range.start && dt < range.end) {
                    rev += Number(e.valor || 0);
                }
            });

            let exp = 0; 
            despesasData.forEach(e => {
                const dt = new Date(e.data + 'T00:00:00');
                if (dt >= range.start && dt < range.end) {
                    exp += Number(e.valor || 0);
                }
            });

            const profit = rev - exp;
            document.getElementById('dash-revenue').innerText = `R$ ${rev.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const expEl = document.getElementById('dash-expense');
            expEl.innerText = `R$ ${exp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const profitEl = document.getElementById('dash-profit');
            profitEl.innerText = `R$ ${profit.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            profitEl.style.color = profit > 0 ? 'var(--success)' : (profit < 0 ? 'var(--danger)' : 'var(--text-muted)');
            
            updateCharts(rev, exp, sMap);
        }

        function updateCharts(rev, exp, sMap) {
            const c1 = document.getElementById('mainChart')?.getContext('2d');
            if(c1) {
                if(mainChart) mainChart.destroy();
                mainChart = new Chart(c1, {
                    type: 'bar',
                    data: { 
                        labels: ['Faturamento', 'Custos'], 
                        datasets: [{ data: [rev, exp], backgroundColor: ['#1e90ff', '#ef4444'], barThickness: 50 }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            y: { 
                                grid: { color: '#333' }, 
                                ticks: { color: '#aaa', font: { size: window.innerWidth < 768 ? 10 : 12 } }, 
                                beginAtZero: true 
                            }, 
                            x: { 
                                ticks: { color: '#aaa', font: { size: window.innerWidth < 768 ? 10 : 12 } }, 
                                grid: { display: false } 
                            } 
                        } 
                    }
                });
            }

            const c2 = document.getElementById('pieChart')?.getContext('2d');
            if(c2) {
                const labels = Object.keys(sMap).sort((a, b) => {
                    const order = ["Corte Masculino", "Barba Completa", "Combo Corte + Barba", "Corte Infantil", "Corte Infantil (Autismo)", "Cortesia"];
                    const indexA = order.findIndex(o => a === o);
                    const indexB = order.findIndex(o => b === o);
                    return (indexA === -1 ? 99 : indexA) - (indexB === -1 ? 99 : indexB);
                });
                
                const data = labels.map(label => sMap[label]);
                const labelsWithValues = labels.map((label, index) => `${label}: ${data[index]}`);

                const backgroundColors = labels.map(label => {
                    const cleanLabel = label.replace("Venda: ", "");
                    return serviceColors[cleanLabel] || serviceColors["Outros"];
                });

                if(pieChart) pieChart.destroy();
                pieChart = new Chart(c2, {
                    type: 'doughnut',
                    data: { 
                        labels: labelsWithValues, 
                        datasets: [{ 
                            data: data, 
                            backgroundColor: backgroundColors, 
                            borderWidth: 0 
                        }] 
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: window.innerWidth < 768 ? 'bottom' : 'right',
                                labels: { 
                                    color: '#aaa', 
                                    boxWidth: 10, 
                                    font: { size: window.innerWidth < 768 ? 9 : 11 },
                                    padding: 10
                                } 
                            } 
                        } 
                    }
                });
            }
        }

        function renderClients() {
            const b = document.getElementById('list-clients'); 
            if(!b) return; 
            b.innerHTML = '';
            const m = {}; 
            
            agendamentosData.filter(a => (a.nome || a.cliente) && ((a.nome || a.cliente) !== 'BLOQUEADO')).forEach(a => {
                const nome = a.nome || a.cliente;
                const fone = (a.telefone || '').trim();
                const email = (a.email || '').trim();
                const uniqueKey = `${nome.toLowerCase()}_${fone}_${email.toLowerCase()}`;

                if(!m[uniqueKey]) {
                    m[uniqueKey] = { 
                        nome: nome, contato: fone, email: email, last: a.data, total: 0, count: 0 
                    };
                }
                
                if(a.status === 'completed') {
                    m[uniqueKey].total += Number(a.preco || 0); 
                    m[uniqueKey].count++;
                    if(new Date(a.data) > new Date(m[uniqueKey].last)) {
                        m[uniqueKey].last = a.data;
                    }
                }
            });

            Object.keys(m).sort((a, b) => { 
                return sortClientsByInactivity
                    ? new Date(m[a].last) - new Date(m[b].last)
                    : new Date(m[b].last) - new Date(m[a].last);
            }).forEach(k => {
                const c = m[k];
                const lastDate = new Date(c.last + 'T00:00:00'); 
                const diffDays = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24)); 

                const btnWhatsapp = c.contato 
                    ? `<button class="btn-action" style="padding:4px 8px;font-size:0.7rem" onclick="notifyInactive('${c.nome}','${c.contato}',${diffDays})">📲 Avisar</button>`
                    : '-';

                // Formatar nome para mobile
                const displayName = window.innerWidth < 768 && c.nome.length > 15 ? 
                    c.nome.substring(0, 12) + '...' : c.nome;
                    
                // Formatar contato para mobile
                const displayContato = c.contato ? 
                    (window.innerWidth < 768 ? c.contato.substring(0, 10) + '...' : c.contato) : 
                    'Sem Telefone';

                b.innerHTML += `
                    <tr>
                        <td><b>${displayName}</b></td>
                        <td>
                            <div style="font-size:0.75rem; color:var(--text-muted)">${displayContato}</div>
                            <div style="font-size:0.7rem; color:var(--primary)">${c.email || ''}</div>
                        </td>
                        <td style="font-size:0.8rem;">${c.last.split('-').reverse().join('/')}</td>
                        <td style="color:var(--primary); font-size:0.8rem;">R$ ${c.total.toFixed(2)}</td>
                        <td style="font-size:0.8rem;">${diffDays} dias</td>
                        <td>${btnWhatsapp}</td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        window.switchFinanceMode = (mode) => {
            financeMode = mode;
            const btnDesp = document.getElementById('toggle-despesas');
            const btnEntr = document.getElementById('toggle-entradas');
            const btnRel = document.getElementById('toggle-relatorios');
            const sectionForm = document.getElementById('section-finance-form');
            const sectionTable = document.getElementById('section-finance-table');
            const sectionRel = document.getElementById('section-relatorios');

            if(mode === 'despesas') {
                btnDesp.classList.add('active');
                btnEntr.classList.remove('active');
                btnRel.classList.remove('active');
                sectionForm.style.display = 'block';
                sectionTable.style.display = 'block';
                sectionRel.style.display = 'none';
                document.getElementById('finance-form-title').innerText = 'Lançar Nova Despesa';
                document.getElementById('label-total-filtrado').innerText = 'Total Despesas';
            } else if(mode === 'entradas') {
                btnEntr.classList.add('active');
                btnDesp.classList.remove('active');
                btnRel.classList.remove('active');
                sectionForm.style.display = 'block';
                sectionTable.style.display = 'block';
                sectionRel.style.display = 'none';
                document.getElementById('finance-form-title').innerText = 'Lançar Venda de Produto';
                document.getElementById('label-total-filtrado').innerText = 'Total Vendas';
                document.getElementById('quick-products-container').style.display = 'block';
            } else if(mode === 'relatorios') {
                btnRel.classList.add('active');
                btnDesp.classList.remove('active');
                btnEntr.classList.remove('active');
                sectionForm.style.display = 'none';
                sectionTable.style.display = 'none';
                sectionRel.style.display = 'block';
            }
            
            // Renderizar tabela apropriada
            renderFinanceTable();
        };

        window.quickAdd = async (cat) => {
            const valor = parseFloat(document.getElementById('exp-val').value);
            const data = document.getElementById('exp-date').value;
            if(isNaN(valor) || !data) {
                showToast('Insira o valor da venda e a data', 'warning');
                return;
            }

            try {
                await addDoc(collection(db, 'entradas_produtos'), { 
                    descricao: cat, valor, data, category: cat, timestamp: new Date() 
                });
                document.getElementById('exp-val').value = '';
                showToast('Venda registrada com sucesso!', 'success');
            } catch(e) { 
                showToast('Erro: ' + e.message, 'error');
            }
        };

        window.addFinanceRecord = async (isPaid) => {
            const desc = document.getElementById('exp-desc').value;
            const valor = parseFloat(document.getElementById('exp-val').value);
            const data = document.getElementById('exp-date').value;
            const recurrence = document.getElementById('exp-recurrence').value;
            const category = document.getElementById('exp-category').value;

            if(isNaN(valor) || !data) {
                showToast('Preencha os campos obrigatórios.', 'warning');
                return;
            }

            const collectionName = financeMode === 'despesas' ? 'despesas' : 'entradas_produtos';
            const payload = { 
                descricao: financeMode === 'despesas' ? desc : category, 
                valor, data, category, timestamp: new Date() 
            };
            if(financeMode === 'despesas') {
                payload.recurrence = recurrence;
                payload.pago = isPaid;
            }

            try {
                await addDoc(collection(db, collectionName), payload);
                document.getElementById('exp-desc').value = '';
                document.getElementById('exp-val').value = '';
                showToast(financeMode === 'despesas' ? 'Despesa registrada!' : 'Venda registrada!', 'success');
            } catch(e) { 
                showToast('Erro ao salvar: ' + e.message, 'error');
            }
        };

        window.togglePaidStatus = async (id, currentStatus) => {
            try {
                await updateDoc(doc(db, "despesas", id), { pago: !currentStatus });
                showToast(`Status alterado para ${!currentStatus ? 'PAGO' : 'PENDENTE'}`, 'success');
            } catch(e) {
                showToast('Erro ao alterar status: ' + e.message, 'error');
            }
        };

        window.deleteFinanceRecord = async (id) => {
            if(confirm('Excluir este registro permanentemente?')) {
                try {
                    const coll = financeMode === 'despesas' ? 'despesas' : 'entradas_produtos';
                    await deleteDoc(doc(db, coll, id));
                    showToast('Registro excluído com sucesso!', 'info');
                } catch(e) {
                    showToast('Erro ao excluir: ' + e.message, 'error');
                }
            }
        };

        window.renderFinanceTable = () => {
            const b = document.getElementById('list-finance');
            const catFilter = document.getElementById('filter-category').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();
            const data = financeMode === 'despesas' ? [...despesasData] : [...entradasData];
            
            b.innerHTML = '';
            let total = 0;
            const rMap = { weekly: 'Semanal', monthly: 'Mensal', yearly: 'Anual' };

            const filteredData = data.filter(item => {
                const matchesCat = catFilter === 'all' || item.category === catFilter;
                const matchesSearch = (item.descricao || '').toLowerCase().includes(searchFilter);
                return matchesCat && matchesSearch;
            });

            filteredData.sort((a, b) => {
                let valA, valB;
                const col = financeSort.column;
                const dir = financeSort.direction === 'asc' ? 1 : -1;
                if (col === 'valor') { valA = Number(a.valor || 0); valB = Number(b.valor || 0); }
                else if (col === 'data') { valA = a.data || ''; valB = b.data || ''; }
                else if (col === 'recurrence') { valA = a.recurrence || ''; valB = b.recurrence || ''; }
                else if (col === 'category') { valA = a.category || ''; valB = b.category || ''; }
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });

            filteredData.forEach(item => {
                const v = Number(item.valor || 0);
                total += v;
                const rLabel = item.recurrence ? (rMap[item.recurrence] || item.recurrence) : '-';
                let statusHtml = '';
                let actionsHtml = '';

                if (financeMode === 'despesas') {
                    const isPaid = item.pago === true;
                    statusHtml = `<td><span class="status-badge ${isPaid ? 'status-pago' : 'status-pendente'}">${isPaid ? 'Pago' : 'Pendente'}</span></td>`;
                    actionsHtml = `<button class="btn-action" style="background:none; color:${isPaid ? 'var(--warn)' : 'var(--success)'}; padding:0; min-width: auto;" onclick="togglePaidStatus('${item.id}', ${isPaid})" title="${isPaid ? 'Marcar como Pendente' : 'Marcar como Pago'}"><i data-lucide="${isPaid ? 'rotate-ccw' : 'check-circle-2'}"></i></button>`;
                } else {
                    statusHtml = '<td>-</td>';
                }

                // Formatar descrição para mobile
                const descricao = item.descricao || '';
                const displayDescricao = window.innerWidth < 768 && descricao.length > 15 ? 
                    descricao.substring(0, 12) + '...' : descricao;

                b.innerHTML += `<tr>
                    <td style="font-size:0.8rem;">${item.data.split('-').reverse().join('/')}</td>
                    <td class="col-recurrence" style="${financeMode === 'entradas' ? 'display:none' : ''}; font-size:0.75rem;">
                        <span style="opacity: 0.7">${rLabel}</span>
                    </td>
                    <td>
                        <span style="background: #1a1a1a; padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; border: 1px solid var(--border); display: inline-block;">
                            ${item.category || 'Outros'}
                        </span>
                    </td>
                    <td style="font-size:0.8rem;">${displayDescricao}</td>
                    ${statusHtml}
                    <td style="color:${financeMode === 'despesas' ? 'var(--warn)' : 'var(--success)'}; font-size:0.8rem;">
                        R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}
                    </td>
                    <td style="text-align: right; display: flex; justify-content: flex-end; gap: 8px;">
                        ${actionsHtml}
                        <button class="btn-action" style="background:none; color:var(--danger); padding:0; min-width: auto;" onclick="deleteFinanceRecord('${item.id}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                </tr>`;
            });

            document.getElementById('filtered-total').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            lucide.createIcons();
        };

        const adminSubscriptionPlans = {
            'sempre-alinhado': { name: 'Sempre Alinhado', price: 79.90, frequency: 'monthly' },
            'combo-executivo': { name: 'Combo Executivo', price: 119.90, frequency: 'monthly' },
            'vip-premium': { name: 'VIP Premium', price: 159.90, frequency: 'monthly' }
        };

        window.updatePlanDetails = () => {
            const planId = document.getElementById('sub-service').value;
            const valueInput = document.getElementById('sub-value');
            if (planId && adminSubscriptionPlans[planId]) valueInput.value = adminSubscriptionPlans[planId].price;
            else valueInput.value = '';
        };

        window.addSubscription = async () => {
            const client = document.getElementById('sub-client').value.trim();
            const telefone = document.getElementById('sub-phone').value.trim();
            const planId = document.getElementById('sub-service').value;
            const value = parseFloat(document.getElementById('sub-value').value);
            const startDate = document.getElementById('sub-start-date').value;
            const status = document.getElementById('sub-status').value;

            if (!client || !planId || !value || !startDate) {
                showToast('Preencha os campos obrigatórios!', 'warning');
                return;
            }

            const plan = adminSubscriptionPlans[planId];
            const nextBilling = new Date(startDate);
            nextBilling.setMonth(nextBilling.getMonth() + 1);

            try {
                await addDoc(collection(db, "assinaturas"), {
                    client, telefone, plan: planId, planName: plan.name, frequency: plan.frequency,
                    value, startDate, nextBilling: nextBilling.toISOString().split('T')[0], status, createdAt: new Date()
                });

                document.getElementById('sub-client').value = '';
                document.getElementById('sub-phone').value = '';
                document.getElementById('sub-service').value = '';
                document.getElementById('sub-value').value = '';
                showToast('Assinatura adicionada com sucesso!', 'success');
            } catch(e) {
                showToast('Erro ao adicionar assinatura: ' + e.message, 'error');
            }
        };

        window.toggleSubscriptionStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            try {
                await updateDoc(doc(db, "assinaturas", id), { status: newStatus });
                showToast(`Assinatura ${newStatus === 'active' ? 'ativada' : 'desativada'}!`, 'success');
            } catch(e) {
                showToast('Erro ao alterar status: ' + e.message, 'error');
            }
        };

        window.deleteSubscription = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta assinatura?')) {
                try {
                    await deleteDoc(doc(db, "assinaturas", id));
                    showToast('Assinatura excluída com sucesso!', 'info');
                } catch(e) {
                    showToast('Erro ao excluir: ' + e.message, 'error');
                }
            }
        };

        window.sendPaymentRequest = (clientName, telefone, amount) => {
            if(!telefone) {
                telefone = prompt("Telefone não encontrado. Digite o WhatsApp do cliente (com DDD):", "2899");
                if(!telefone) return;
            }
            const clean = telefone.toString().replace(/\D/g, "");
            const fullPhone = clean.startsWith("55") ? clean : "55" + clean;
            const msg = encodeURIComponent(
                `Olá, ${clientName}! 👋\n\n` +
                `Estou passando para lembrá-lo da sua assinatura na *Lopes Barbearia*! ✂️\n\n` +
                `Valor: *R$ ${amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}*\n` +
                `PIX: *28999082741*\n\n` +
                `Pode nos enviar o comprovante após o pagamento? 😉`
            );
            window.open(`https://api.whatsapp.com/send?phone=${fullPhone}&text=${msg}`);
        };

        function renderSubscriptions() {
            const tbody = document.getElementById('list-subscriptions');
            if (!tbody) return;

            tbody.innerHTML = subscriptionsData.map(sub => {
                const statusBadge = sub.status === 'active' 
                    ? '<span class="status-badge status-pago">Ativa</span>' 
                    : '<span class="status-badge status-pendente">Inativa</span>';

                const targetPhone = (sub.clientPhone || sub.telefone || sub.phone || '').toString();
                const escapedClient = (sub.client || '').replace(/'/g, "\\'");
                
                // Formatar para mobile
                const displayClient = window.innerWidth < 768 && sub.client.length > 10 ? 
                    sub.client.substring(0, 8) + '...' : sub.client;
                const displayPlan = window.innerWidth < 768 && sub.planName.length > 10 ? 
                    sub.planName.substring(0, 8) + '...' : sub.planName;

                return `<tr>
                    <td><b>${displayClient}</b></td>
                    <td style="font-size:0.8rem;">${targetPhone || '-'}</td>
                    <td style="font-size:0.8rem;">${displayPlan}</td>
                    <td style="color:var(--primary); font-size:0.8rem;">R$ ${sub.value.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td style="font-size:0.8rem;">${sub.startDate.split('-').reverse().join('/')}</td>
                    <td style="font-size:0.8rem;">${sub.nextBilling.split('-').reverse().join('/')}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align: right;">
                        <div class="action-buttons">
                            <button class="btn-action" style="background: #25d366; padding: 4px 6px; font-size:0.7rem;" onclick="sendPaymentRequest('${escapedClient}', '${targetPhone}', ${sub.value})">
                                <i data-lucide="message-circle"></i>
                            </button>
                            <button class="btn-action" style="background: var(--primary); padding: 4px 6px; font-size:0.7rem;" onclick="toggleSubscriptionStatus('${sub.id}', '${sub.status}')">
                                ${sub.status === 'active' ? 'Desativar' : 'Ativar'}
                            </button>
                            <button class="btn-action" style="background: var(--danger); padding: 4px 6px; font-size:0.7rem;" onclick="deleteSubscription('${sub.id}')">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        };

        function renderServices() {
            const tbody = document.getElementById('list-services');
            if (!tbody) return;

            tbody.innerHTML = servicesData.map(service => {
                // Formatar nome para mobile
                const displayName = window.innerWidth < 768 && service.name.length > 15 ? 
                    service.name.substring(0, 12) + '...' : service.name;
                    
                return `
                <tr>
                    <td>${displayName}</td>
                    <td><input type="number" value="${service.duration}" onchange="updateService('${service.id}', 'duration', this.value)" style="width: 60px; padding: 4px; font-size: 0.8rem;"></td>
                    <td><input type="number" step="0.01" value="${service.price}" onchange="updateService('${service.id}', 'price', this.value)" style="width: 80px; padding: 4px; font-size: 0.8rem;"></td>
                    <td style="text-align: right;">
                        <button class="btn-action" onclick="saveService('${service.id}')" style="padding: 4px 8px; font-size: 0.7rem;">Salvar</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.updateService = (id, field, value) => {
            const service = servicesData.find(s => s.id === id);
            if (service) {
                service[field] = field === 'price' ? parseFloat(value) : parseInt(value);
            }
        };

        window.saveService = async (id) => {
            const service = servicesData.find(s => s.id === id);
            if (!service) return;

            try {
                await updateDoc(doc(db, "services", id), {
                    duration: service.duration,
                    price: service.price
                });
                showToast('Serviço atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar serviço:', error);
                showToast('Erro ao salvar serviço.', 'error');
            }
        };

        // FUNÇÃO PARA GERAR RELATÓRIO FISCAL
        window.generateFiscalReport = () => {
            const year = document.getElementById('report-year').value;
            const month = document.getElementById('report-month').value;
            const week = document.getElementById('report-week').value;
            
            if (!year) {
                showToast('Por favor, selecione um ano.', 'warning');
                return;
            }

            let startDate, endDate, periodText;

            if (month && week) {
                // Filtro por semana específica
                const monthStart = new Date(`${year}-${month}-01`);
                const weekNum = parseInt(week);
                
                // Calcular início da semana
                startDate = new Date(monthStart);
                if (weekNum === 1) {
                    startDate.setDate(1);
                } else if (weekNum === 2) {
                    startDate.setDate(8);
                } else if (weekNum === 3) {
                    startDate.setDate(15);
                } else if (weekNum === 4) {
                    startDate.setDate(22);
                } else if (weekNum === 5) {
                    startDate.setDate(29);
                }
                
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                // Ajustar se ultrapassar o último dia do mês
                const lastDay = new Date(year, parseInt(month), 0).getDate();
                if (endDate.getDate() > lastDay) {
                    endDate.setDate(lastDay);
                }
                
                periodText = `Semana ${week} de ${getMonthName(month)}/${year}`;
                
            } else if (month) {
                // Filtro por mês
                startDate = new Date(`${year}-${month}-01`);
                endDate = new Date(year, parseInt(month), 0);
                periodText = `${getMonthName(month)}/${year}`;
                
            } else {
                // Filtro por ano
                startDate = new Date(`${year}-01-01`);
                endDate = new Date(`${year}-12-31`);
                periodText = `Ano ${year}`;
            }

            // Ajustar para incluir o dia inteiro
            endDate.setHours(23, 59, 59, 999);

            const reportData = [];
            let totalServicos = 0;
            let totalProdutos = 0;
            let countServicos = 0;
            let countProdutos = 0;

            // Filtrar agendamentos concluídos
            agendamentosData.forEach(agendamento => {
                if (agendamento.status === 'completed' && agendamento.data) {
                    const agDate = new Date(agendamento.data + 'T00:00:00');
                    if (agDate >= startDate && agDate <= endDate) {
                        reportData.push({
                            data: agendamento.data,
                            tipo: 'Serviço',
                            cliente: agendamento.nome || agendamento.cliente || 'Cliente não informado',
                            descricao: agendamento.servico || 'Serviço não informado',
                            valor: agendamento.preco || 0
                        });
                        totalServicos += Number(agendamento.preco || 0);
                        countServicos++;
                    }
                }
            });

            // Filtrar vendas de produtos
            entradasData.forEach(entrada => {
                if (entrada.data) {
                    const entDate = new Date(entrada.data + 'T00:00:00');
                    if (entDate >= startDate && entDate <= endDate) {
                        reportData.push({
                            data: entrada.data,
                            tipo: 'Produto',
                            cliente: 'Cliente não informado',
                            descricao: entrada.descricao || entrada.category || 'Produto não informado',
                            valor: entrada.valor || 0
                        });
                        totalProdutos += Number(entrada.valor || 0);
                        countProdutos++;
                    }
                }
            });

            // Ordenar por data
            reportData.sort((a, b) => new Date(a.data) - new Date(b.data));

            // Renderizar tabela
            const tbody = document.getElementById('report-table-body');
            if (reportData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-muted); font-size: 0.8rem;">
                            Nenhum registro encontrado para o período selecionado.
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = reportData.map(item => {
                    // Formatar para mobile
                    const displayCliente = window.innerWidth < 768 && item.cliente.length > 10 ? 
                        item.cliente.substring(0, 8) + '...' : item.cliente;
                    const displayDescricao = window.innerWidth < 768 && item.descricao.length > 15 ? 
                        item.descricao.substring(0, 12) + '...' : item.descricao;
                    
                    return `
                    <tr>
                        <td style="font-size:0.8rem;">${item.data.split('-').reverse().join('/')}</td>
                        <td style="font-size:0.8rem;"><span style="color: ${item.tipo === 'Serviço' ? 'var(--primary)' : 'var(--success)'}">${item.tipo}</span></td>
                        <td style="font-size:0.8rem;">${displayCliente}</td>
                        <td style="font-size:0.8rem;">${displayDescricao}</td>
                        <td style="color: var(--primary); font-weight: bold; font-size:0.8rem;">R$ ${item.valor.toFixed(2)}</td>
                    </tr>
                    `;
                }).join('');
            }

            // Calcular total
            const total = totalServicos + totalProdutos;
            document.getElementById('report-total').innerText = `Total do período: R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('report-summary').innerText = `${countServicos} serviços + ${countProdutos} produtos`;
            document.getElementById('report-period-info').innerText = `Período: ${periodText}`;

            // Mostrar resultados
            document.getElementById('report-results').style.display = 'block';
            
            // Scroll para os resultados no mobile
            if (window.innerWidth < 768) {
                document.getElementById('report-results').scrollIntoView({behavior: 'smooth'});
            }

            // Armazenar dados para exportação
            window.currentFiscalReportData = {
                data: reportData,
                period: periodText,
                total: total,
                summary: `${countServicos} serviços + ${countProdutos} produtos`
            };
            
            showToast('Relatório gerado com sucesso!', 'success');
        };

        // FUNÇÃO PARA EXPORTAR RELATÓRIO FISCAL
        window.exportFiscalReport = () => {
            if (!window.currentFiscalReportData || window.currentFiscalReportData.data.length === 0) {
                showToast('Nenhum dado para exportar.', 'warning');
                return;
            }

            const { data, period, total, summary } = window.currentFiscalReportData;
            
            // Cabeçalho do CSV
            let csvContent = `Relatório Fiscal - ${period}\n`;
            csvContent += `Gerado em: ${new Date().toLocaleDateString('pt-BR')}\n`;
            csvContent += `Total: R$ ${total.toFixed(2)} (${summary})\n\n`;
            
            // Cabeçalhos das colunas
            csvContent += 'Data,Tipo,Cliente,Descrição,Valor\n';
            
            // Dados
            data.forEach(item => {
                csvContent += `${item.data},${item.tipo},"${item.cliente}","${item.descricao}",${item.valor.toFixed(2)}\n`;
            });

            // Criar e baixar arquivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio-fiscal-${period.replace(/[\/ ]/g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Relatório exportado com sucesso!', 'success');
        };

        // FUNÇÃO AUXILIAR PARA OBTER NOME DO MÊS
        function getMonthName(monthNumber) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[parseInt(monthNumber) - 1] || '';
        }

        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar data atual nos campos
            const today = new Date().toISOString().split('T')[0];
            const subStart = document.getElementById('sub-start-date');
            if(subStart) subStart.value = today;
            
            const expDate = document.getElementById('exp-date');
            if(expDate) expDate.value = today;

            // Definir ano atual no relatório
            const currentYear = new Date().getFullYear().toString();
            const yearSelect = document.getElementById('report-year');
            if(yearSelect) yearSelect.value = currentYear;

            // Inicializar ícones
            lucide.createIcons();
            
            // Mostrar/ocultar botão voltar ao topo baseado no scroll
            window.addEventListener('scroll', () => {
                const backToTop = document.querySelector('.back-to-top');
                if (backToTop) {
                    if (window.scrollY > 300) {
                        backToTop.style.display = 'flex';
                    } else {
                        backToTop.style.display = 'none';
                    }
                }
            });
            
            // Fechar menu ao pressionar ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeMenu();
                }
            });
            
            // Prevenir zoom duplo em mobile
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Garantir que o menu lateral fique visível no desktop
            const checkDesktopMenu = () => {
                if (window.innerWidth >= 768) {
                    const aside = document.querySelector('aside');
                    if (aside) {
                        aside.style.transform = 'translateX(0)';
                        aside.style.display = 'flex';
                    }
                    
                    const adminPanel = document.getElementById('admin-panel');
                    if (adminPanel && window.getComputedStyle(adminPanel).display !== 'none') {
                        adminPanel.style.display = 'grid';
                    }
                }
            };
            
            // Verificar ao carregar e ao redimensionar
            checkDesktopMenu();
            window.addEventListener('resize', checkDesktopMenu);
        });

    </script>
</body>
</html>